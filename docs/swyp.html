<!DOCTYPE html>  <html> <head>   <title>swyp.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="secrets.html">                 secrets.coffee               </a>                                           <a class="source" href="swyp.html">                 swyp.coffee               </a>                                           <a class="source" href="swypClient.html">                 swypClient.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               swyp.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mongoose     = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;mongoose&#39;</span><span class="p">)</span>
<span class="nv">mongooseAuth = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;mongoose-auth&#39;</span><span class="p">)</span>
<span class="nv">Schema = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span>

<span class="nv">ObjectId = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">SchemaTypes</span><span class="p">.</span><span class="nx">ObjectId</span>
<span class="nv">User = </span><span class="kc">null</span>

<span class="nv">UserSchema = </span><span class="k">new</span> <span class="nx">Schema</span> <span class="p">{}</span>
<span class="nx">UserSchema</span><span class="p">.</span><span class="nx">plugin</span> <span class="nx">mongooseAuth</span><span class="p">,</span> <span class="p">{</span>
  <span class="nv">everymodule:</span>
    <span class="nv">everyauth:</span>
      <span class="nv">User: </span><span class="o">-&gt;</span> <span class="nx">User</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>sessions are contained within accounts, and represent an active connection to the swypServer
sessions contain the socket.io socket id via 'socketID', and the current location of the user</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Session = </span><span class="k">new</span> <span class="nx">Schema</span> <span class="p">{</span>
  <span class="nv">token : </span><span class="nb">String</span><span class="p">,</span>
  <span class="nv">socketID : </span><span class="nb">String</span><span class="p">,</span>
  <span class="nv">expiration : </span><span class="nb">Date</span><span class="p">,</span>
  <span class="nv">location : </span><span class="p">[</span> <span class="nb">Number</span><span class="p">,</span> <span class="nb">Number</span><span class="p">]</span> <span class="c1">#long,lat as suggested: http://www.mongodb.org/display/DOCS/Geospatial+Indexing </span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>the account schema contains the user information and login credentials
the userIDs are unique, and can be universal identifiers (more internal than userName)
the userName is the display name for other users to see
the account document contains the session embeddedDocument </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">AccountSchema = </span><span class="k">new</span> <span class="nx">Schema</span> <span class="p">{</span>
  <span class="nv">userImageURL : </span><span class="nb">String</span><span class="p">,</span>
  <span class="nv">userID : </span><span class="p">{</span> <span class="nv">type: </span><span class="nb">String</span><span class="p">,</span> <span class="nv">index: </span><span class="p">{</span> <span class="nv">unique: </span><span class="kc">true</span> <span class="p">}},</span>
  <span class="nv">userName : </span><span class="p">{</span> <span class="nv">type: </span><span class="nb">String</span><span class="p">,</span> <span class="nv">index: </span><span class="p">{</span> <span class="nv">unique: </span><span class="kc">true</span> <span class="p">}},</span>
  <span class="nv">userPass : </span><span class="nb">String</span>
  <span class="nv">sessions : </span><span class="p">[</span><span class="nx">Session</span><span class="p">]</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>each contentType the swyp-out supports generates one of these
typeGroups are fufilled as necessary to honor requests through swyp-ins</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">TypeGroupSchema = </span><span class="k">new</span> <span class="nx">Schema</span> <span class="p">{</span>
  <span class="nv">contentURL : </span><span class="nb">String</span>
  <span class="nv">contentMIME : </span><span class="nb">String</span>
  <span class="nv">requestingUserIDs : </span><span class="p">[</span><span class="nb">String</span><span class="p">]</span>
  <span class="nv">uploadTimeoutDate : </span><span class="nb">Date</span>
  <span class="nv">uploadCompletionDate : </span><span class="nb">Date</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>each swyp-out generates one of these
it contains typeGroups, which are the various contentTypes supported by a specific swyped-out content
swypOuterID corresponds to a unique Account.userID</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">SwypSchema = </span><span class="k">new</span> <span class="nx">Schema</span> <span class="p">{</span>
  <span class="nv">swypOuterID : </span><span class="nb">String</span><span class="p">,</span>
  <span class="nv">swypRecipientID : </span><span class="nb">String</span><span class="p">,</span>
  <span class="nv">dateCreated : </span><span class="nb">Date</span><span class="p">,</span>
  <span class="nv">dateExpires : </span><span class="nb">Date</span><span class="p">,</span>
  <span class="nv">previewImageJPG : </span><span class="nb">String</span><span class="p">,</span>
  <span class="nv">typeGroups : </span><span class="p">[</span><span class="nx">TypeGroup</span><span class="p">]</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">Swyp</span> <span class="nx">Schema</span> <span class="o">--</span> <span class="nx">Determine</span> <span class="nx">whether</span> <span class="nx">embedded</span> <span class="k">in</span> <span class="nx">session</span><span class="p">,</span> <span class="o">or</span> <span class="nx">seperate</span>
<span class="err">•</span> <span class="nx">Swyps</span> <span class="nx">created</span> <span class="kc">on</span> <span class="nx">swypOut</span> <span class="nx">event</span>
<span class="err">•</span> <span class="nx">Swyps</span> <span class="nx">stored</span> <span class="nv">track:</span>
  <span class="o">-</span> <span class="nx">typeGroups</span> <span class="p">[</span><span class="nx">array</span> <span class="k">of</span> <span class="nx">hashtables</span><span class="p">]</span>
    <span class="o">-</span> <span class="nx">URL</span> <span class="nx">location</span>
    <span class="o">-</span> <span class="nx">Requesting</span> <span class="nx">userIDs</span>
  <span class="o">-</span> <span class="nx">swyp</span><span class="o">-</span><span class="nx">out</span> <span class="nx">ownerID</span>
  <span class="o">-</span> <span class="nx">expiration</span> <span class="nx">date</span>
  <span class="o">-</span> <span class="nx">previewImage</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Account = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span> <span class="s">&#39;Account&#39;</span><span class="p">,</span> <span class="nx">AccountSchema</span>
<span class="nv">Swyp = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span> <span class="s">&#39;Swyp&#39;</span><span class="p">,</span> <span class="nx">SwypSchema</span>
<span class="nv">TypeGroup = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span> <span class="s">&#39;Swyp.typeGroups&#39;</span><span class="p">,</span> <span class="nx">TypeGroupSchema</span>
<span class="o">`</span><span class="nb">Array</span><span class="p">.</span><span class="nv">prototype.unique = </span><span class="nx">function</span><span class="p">()</span> <span class="p">{</span>    <span class="nx">var</span> <span class="nv">o = </span><span class="p">{},</span> <span class="nx">i</span><span class="p">,</span> <span class="nv">l = </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nv">r = </span><span class="p">[];</span>    <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span><span class="nx">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">)</span> <span class="nx">o</span><span class="p">[</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>    <span class="k">for</span><span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">o</span><span class="p">)</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>    <span class="k">return</span> <span class="nx">r</span><span class="p">;};</span><span class="o">`</span>

<span class="nv">swypApp = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;zappa&#39;</span><span class="p">).</span><span class="nx">app</span> <span class="o">-&gt;</span>
  <span class="nx">@include</span> <span class="s">&#39;secrets&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>@mongoDBConnectURLSecret =  "mongodb://..."</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">@mongoDBConnectURLSecret</span><span class="p">)</span>

  <span class="nv">self = </span><span class="k">this</span>

  <span class="nx">@use</span> <span class="s">&#39;bodyParser&#39;</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;cookies&#39;</span><span class="p">,</span> <span class="s">&#39;cookieParser&#39;</span><span class="p">,</span> <span class="nv">session: </span><span class="p">{</span><span class="nv">secret: </span><span class="nx">@sessionSecret</span><span class="p">}</span>
  <span class="nx">@enable</span> <span class="s">&#39;default layout&#39;</span> <span class="c1"># this is hella convenient</span>

  <span class="nx">@io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&quot;transports&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;xhr-polling&quot;</span><span class="p">])</span>
  <span class="nx">@io</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&quot;polling duration&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
  
  <span class="nx">@include</span> <span class="s">&#39;swypClient&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>this method performs a callback with (error, account, activeSessions) w. the relevant account for a userID, as well as associated active sessions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">accountForUserID = </span><span class="nf">(userID, callback) -&gt;</span> <span class="c1">#callback(error, account, activeSessions)</span>
     <span class="nx">Account</span><span class="p">.</span><span class="nx">find</span> <span class="p">{</span><span class="s">&quot;userID&quot;</span> <span class="o">:</span> <span class="nx">userID</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span>  <span class="o">=&gt;</span>
      <span class="nv">accountFound = </span><span class="nx">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
      <span class="k">if</span> <span class="nx">accountFound</span><span class="o">?</span>
        <span class="nv">activeSessions = </span><span class="nx">activeSessionsForAccount</span><span class="p">(</span><span class="nx">accountFound</span><span class="p">)</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">accountFound</span><span class="p">,</span> <span class="nx">activeSessions</span>
      <span class="k">else</span>
        <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>this method asynchronously evaluates the validity of an Account session</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tokenValidate = </span><span class="nf">(token, callback) -&gt;</span>
    <span class="nv">accountFound = </span><span class="kc">null</span>
    <span class="nv">session = </span><span class="kc">null</span>
    <span class="nx">Account</span><span class="p">.</span><span class="nx">find</span> <span class="p">{</span><span class="s">&quot;sessions.token&quot;</span> <span class="o">:</span> <span class="nx">token</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span>  <span class="o">=&gt;</span>
      <span class="nv">accountFound = </span><span class="nx">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="kc">null</span>
      <span class="k">if</span> <span class="nx">accountFound</span> <span class="o">!=</span> <span class="kc">null</span>
        <span class="nx">accountFound</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">forEach</span> <span class="nf">(obj, i) -&gt;</span>
          <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">token</span>
            <span class="nv">session = </span><span class="nx">obj</span>
      <span class="nx">callback</span> <span class="nx">accountFound</span><span class="p">,</span> <span class="nx">session</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <pre><code> console.log "found user #{accountFound} for session #{session} andtoken #{token}"
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>checkyourselfbeforeyouwreckyourself.... asynchronous recersion, yo.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">recursiveGetAccountsAtLocationArray = </span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">locationsArray</span><span class="p">,</span> <span class="nx">uniqueAccounts</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1">#recursive function #callback(error, uniqueAccounts)</span>
    <span class="nv">maxDistanceRadial = </span><span class="mi">1</span><span class="o">/</span><span class="mi">6378</span> <span class="c1">#in radial coord km/radiusEarth *ONLY WORKS ON EARTH*</span>
    <span class="nv">nextAccounts = </span><span class="p">[]</span>
    <span class="nv">nextAccounts = </span><span class="nx">locationsArray</span> <span class="k">if</span> <span class="nx">locationsArray</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">locationsArray</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="o">?</span>
      <span class="nv">nextLocation = </span><span class="nx">locationsArray</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
      <span class="nx">Account</span><span class="p">.</span><span class="nx">find</span> <span class="p">{</span> <span class="s">&quot;sessions.location&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="nv">$nearSphere : </span><span class="nx">nextLocation</span><span class="p">,</span> <span class="nv">$maxDistance : </span><span class="nx">maxDistanceRadial</span> <span class="p">}},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;error on session location lookup </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="kc">null</span>
          <span class="k">return</span>
        <span class="k">if</span> <span class="nx">docs</span><span class="o">?</span>
          <span class="nv">nextAccounts = </span><span class="nx">nextAccounts</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">docs</span><span class="p">).</span><span class="nx">unique</span><span class="p">()</span>
          <span class="nx">recursiveGetAccountsAtLocationArray</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">locationsArray</span><span class="p">,</span> <span class="nx">nextAccounts</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">uniqueAccounts</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>here we iterate over all active sessions near the old and new location of a session, then we update each session with its relevant nearby users</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">updateUniqueActiveSessionsNearLocationArray = </span><span class="p">(</span><span class="nx">locations</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1">#callback(error)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>console.log "updating nearby sessions to #{locations}"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">recursiveGetAccountsAtLocationArray</span> <span class="mi">0</span><span class="p">,</span><span class="nx">locations</span><span class="p">,[],</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">uniqueAccounts</span><span class="p">)</span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>console.log "found relevant accounts #{uniqueAccounts.length}"</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">activeSessions = </span><span class="p">[]</span>
      <span class="nx">uniqueAccounts</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">sessionsForAccount = </span><span class="nx">activeSessionsForAccount</span> <span class="nx">obj</span>
        <span class="k">if</span> <span class="nx">sessionsForAccount</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
          <span class="nv">activeSessions = </span><span class="nx">activeSessions</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">sessionsForAccount</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">session</span> <span class="k">in</span> <span class="nx">activeSessions</span>
        <span class="nx">relevantAccountsNearSession</span> <span class="p">(</span><span class="nx">session</span><span class="p">),</span> <span class="p">(</span><span class="nx">relevantUpdate</span><span class="p">,</span> <span class="nx">theSession</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nv">socket = </span><span class="nx">socketForSession</span><span class="p">(</span><span class="nx">theSession</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">socket</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">relevantUpdate</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>console.log "nearbyrefreshing for sessionID #{theSession.socketID}"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s">&#39;nearbyRefresh&#39;</span><span class="p">,</span> <span class="nx">relevantUpdate</span><span class="p">)</span>

  <span class="nv">accountsAndSessionsNearLocation = </span><span class="nf">(location, callback) -&gt;</span> <span class="c1">#callback([{sessions:[Session], account: Account}], allSessions)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>for now we just return all active sessions for accounts with any nearby session</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">recursiveGetAccountsAtLocationArray</span> <span class="mi">0</span><span class="p">,[</span><span class="nx">location</span><span class="p">],[],</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">uniqueAccounts</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nv">allSessions = </span><span class="p">[]</span>
      <span class="nv">sessionsByAccount = </span><span class="p">[]</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;error on session location lookup </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span>
      <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">uniqueAccounts</span>
        <span class="nv">sessionsForAccount = </span><span class="nx">activeSessionsForAccount</span> <span class="nx">obj</span>
        <span class="k">if</span> <span class="nx">sessionsForAccount</span><span class="o">?</span> <span class="o">&amp;&amp;</span>  <span class="nx">sessionsForAccount</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nx">sessionsByAccount</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">sessionsForAccount</span><span class="p">])</span>
          <span class="nv">allSessions = </span><span class="nx">allSessions</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">sessionsForAccount</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">allSessions</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="err">#</span><span class="s"> active session local&quot;</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">sessionsByAccount</span><span class="p">,</span> <span class="nx">allSessions</span><span class="p">)</span>
  
  <span class="nv">accountOwnsSession = </span><span class="nf">(account, session) -&gt;</span>
    <span class="k">for</span> <span class="nx">ses</span> <span class="k">in</span> <span class="nx">account</span><span class="p">.</span><span class="nx">sessions</span>
      <span class="k">if</span> <span class="nx">ses</span><span class="p">.</span><span class="nx">token</span> <span class="o">==</span> <span class="nx">session</span><span class="p">.</span><span class="nx">token</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="k">return</span> <span class="kc">false</span>
   
  <span class="nv">relevantAccountsNearSession = </span><span class="nf">(session, callback) -&gt;</span> <span class="c1">#callback([{sessions:[Session], account: Account}], theSession)</span>
    <span class="nx">Account</span><span class="p">.</span><span class="nx">find</span> <span class="p">{</span><span class="s">&quot;sessions.location&quot;</span> <span class="o">:</span> <span class="p">{</span> <span class="nv">$nearSphere : </span><span class="nx">session</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="nv">$maxDistance : </span><span class="mi">1</span><span class="o">/</span><span class="mi">6378</span>  <span class="p">}},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;error on session location lookup </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
         <span class="k">return</span>
      <span class="k">if</span> <span class="nx">docs</span><span class="o">?</span>
        <span class="nv">relevantAccounts = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">acc</span> <span class="k">in</span> <span class="nx">docs</span>
          <span class="k">if</span> <span class="nx">accountOwnsSession</span> <span class="nx">acc</span><span class="p">,</span> <span class="nx">session</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>console.log "acc #{acc.userID} owns session with token #{session.token}"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">sessionsForAccount = </span><span class="nx">activeSessionsForAccount</span> <span class="nx">acc</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>if more than one active session for the current account, then good!</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">sessionsForAccount</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">?</span>
              <span class="nx">relevantAccounts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">acc</span>
            <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>console.log "current user w. session #{session.socketID} ignored bcuz only 1 session"</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>console.log "acc #{acc.userID} does not own session with token #{session.token}"</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">relevantAccounts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">acc</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>don't need to send session details to every client, we don't save, so this is NBD</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">shareAccounts = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">acc</span> <span class="k">in</span> <span class="nx">relevantAccounts</span>
          <span class="nx">shareAccounts</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nv">userID: </span><span class="nx">acc</span><span class="p">.</span><span class="nx">userID</span><span class="p">,</span> <span class="nv">userImageURL: </span><span class="nx">acc</span><span class="p">.</span><span class="nx">userImageURL</span><span class="p">}</span>
       </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>console.log "sessionToken #{session.token} gets accounts :"</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">sendVal = </span><span class="p">{</span><span class="nv">nearby: </span><span class="nx">shareAccounts</span><span class="p">}</span>
        <span class="nx">callback</span> <span class="nx">sendVal</span><span class="p">,</span> <span class="nx">session</span>
    
  <span class="nv">socketForSession = </span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">socketID</span><span class="p">]</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">@io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">sockets</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">socketID</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;session no socket </span><span class="si">#{</span><span class="nx">session</span><span class="p">.</span><span class="nx">socketID</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="kc">null</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>grabs the active sessions for an accout, and returns in-line</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">activeSessionsForAccount = </span><span class="p">(</span><span class="nx">account</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">activeSessions = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nx">account</span><span class="p">.</span><span class="nx">sessions</span><span class="o">?</span>
      <span class="nx">account</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">expiration</span> <span class="o">&gt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">||</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">expiration</span><span class="o">?</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">@io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">socket</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">socketID</span><span class="p">)</span><span class="o">?</span>
          <span class="nx">activeSessions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">activeSessions</span>
  
  <span class="nx">@post</span> <span class="s">&#39;/signup&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
    <span class="nv">userName   = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user_name</span>
    <span class="nv">userPassword = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user_pass</span>
    <span class="k">if</span> <span class="nx">userName</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="o">and</span> <span class="nx">userPassword</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span>
      <span class="nv">newAccount = </span><span class="k">new</span> <span class="nx">Account</span><span class="p">()</span>
      <span class="nx">newAccount</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span><span class="nv">userPass: </span><span class="nx">userPassword</span><span class="p">}</span>
      <span class="nx">newAccount</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span><span class="nv">userName: </span><span class="nx">userName</span><span class="p">,</span> <span class="nv">userID: </span><span class="nx">userName</span><span class="p">}</span>
      <span class="nx">newAccount</span><span class="p">.</span><span class="nx">save</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">error</span> <span class="o">!=</span> <span class="kc">null</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;didFailSave&quot;</span><span class="p">,</span> <span class="nx">error</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">newAccount</span>
          <span class="nx">@render</span> <span class="nv">signup: </span><span class="p">{</span><span class="nv">user_name: </span><span class="nx">userName</span><span class="p">}</span>
        <span class="k">else</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;signup success for&quot;</span><span class="p">,</span> <span class="nx">uSerName</span>
          <span class="nx">@redirect</span> <span class="s">&#39;/token&#39;</span>
    <span class="k">else</span>
      <span class="nx">@render</span> <span class="nv">signup: </span><span class="p">{</span><span class="nv">user_name: </span><span class="nx">userName</span><span class="p">}</span>


  <span class="nx">@get</span> <span class="s">&#39;/signup&#39;</span><span class="o">:</span> <span class="o">-&gt;</span>
    <span class="nx">@render</span> <span class="nv">signup: </span><span class="p">{}</span>
  
  <span class="nx">@view</span> <span class="nv">signup: </span><span class="o">-&gt;</span>
    <span class="vi">@title = </span><span class="s">&#39;signup&#39;</span>
    <span class="vi">@stylesheets = </span><span class="p">[</span><span class="s">&#39;/style&#39;</span><span class="p">]</span>
    <span class="vi">@scripts = </span><span class="p">[</span><span class="s">&#39;/zappa/jquery&#39;</span><span class="p">,</span><span class="s">&#39;/zappa/zappa&#39;</span><span class="p">]</span>
                                
    <span class="nx">form</span> <span class="nv">method: </span><span class="s">&#39;post&#39;</span><span class="p">,</span> <span class="nv">action: </span><span class="s">&#39;/signup&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">input</span> <span class="nv">id: </span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="nv">name: </span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="nv">placeholder: </span><span class="s">&#39;login user&#39;</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">50</span>
      <span class="nx">input</span> <span class="nv">id: </span><span class="s">&#39;user_pass&#39;</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="nv">name: </span><span class="s">&#39;user_pass&#39;</span><span class="p">,</span> <span class="nv">placeholder: </span><span class="s">&#39;login pass&#39;</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">50</span>
      <span class="nx">button</span> <span class="s">&#39;signup&#39;</span>

  <span class="nv">getTokenFromUserName = </span><span class="p">(</span><span class="nx">userName</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1">#callback(err, account, session)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;finding </span><span class="si">#{</span><span class="nx">userName</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">Account</span><span class="p">.</span><span class="nx">find</span> <span class="p">{</span><span class="nv">userName: </span><span class="nx">userName</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span>  <span class="o">=&gt;</span>
      <span class="nv">matchingUser = </span><span class="nx">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>console.log 'docs',docs, 'with first', matchingUser</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">matchingUser</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">matchingUser</span> <span class="o">==</span> <span class="kc">undefined</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;login failed for </span><span class="si">#{</span><span class="nx">userName</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">callback</span> <span class="s">&quot;baduser&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span>
        <span class="k">return</span>

      <span class="k">if</span> <span class="nx">matchingUser</span><span class="p">.</span><span class="nx">userPass</span> <span class="o">!=</span> <span class="nx">password</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;login pass failed for </span><span class="si">#{</span><span class="nx">matchingUser</span><span class="p">.</span><span class="nx">userName</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">matchingUser</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="nx">callback</span> <span class="s">&quot;badpass&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span>
        <span class="k">return</span>
       
      <span class="k">if</span> <span class="nx">matchingUser</span> <span class="o">!=</span> <span class="kc">null</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;match user&quot;</span>
        <span class="k">if</span> <span class="nx">matchingUser</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="nv">newToken = </span><span class="s">&quot;TOKENBLAH_</span><span class="si">#{</span><span class="nx">matchingUser</span><span class="p">.</span><span class="nx">userName</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Newtoken created </span><span class="si">#{</span><span class="nx">newToken</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nv">session = </span> <span class="k">new</span> <span class="nx">Session</span> <span class="p">{</span><span class="nv">token: </span><span class="nx">newToken</span><span class="p">}</span>
          <span class="nx">matchingUser</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">session</span>
          <span class="nx">matchingUser</span><span class="p">.</span><span class="nx">save</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">error</span> <span class="o">!=</span> <span class="kc">null</span>
              <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;didFailSave&quot;</span><span class="p">,</span> <span class="nx">error</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;create new session success for&quot;</span><span class="p">,</span> <span class="nx">matchingUser</span><span class="p">.</span><span class="nx">userName</span>
            <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">matchingUser</span><span class="p">,</span> <span class="nx">session</span>
        <span class="k">else</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;login session success for&quot;</span><span class="p">,</span> <span class="nx">matchingUser</span><span class="p">.</span><span class="nx">userName</span>
          <span class="nv">previousSession = </span><span class="nx">matchingUser</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">matchingUser</span><span class="p">,</span> <span class="nx">previousSession</span>

  
  <span class="nx">@post</span> <span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">reqName  = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user_name</span>
    <span class="nv">reqPassword = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user_pass</span>
    <span class="nv">fbId = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fb_uid</span>
    <span class="nv">fbToken = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">fb_token</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;get token&quot;</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">clearCookie</span> <span class="s">&#39;sessiontoken&#39;</span>
    <span class="nx">getTokenFromUserName</span> <span class="nx">reqName</span><span class="p">,</span><span class="nx">reqPassword</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">account</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">render</span> <span class="nv">login: </span><span class="p">{</span><span class="nv">error: </span><span class="nx">err</span><span class="p">}</span>
      <span class="k">else</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">cookie</span> <span class="s">&#39;sessiontoken&#39;</span><span class="p">,</span> <span class="nx">session</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="p">{</span> <span class="nv">maxAge: </span><span class="mi">90000000000</span> <span class="p">}</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">redirect</span> <span class="s">&#39;/&#39;</span>
  
  <span class="nx">@get</span> <span class="s">&#39;/login&#39;</span><span class="o">:</span> <span class="o">-&gt;</span>
    <span class="nx">@render</span> <span class="nv">login: </span><span class="p">{}</span>

  <span class="nx">@post</span> <span class="s">&#39;/token&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
    <span class="nv">reqName  = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user_name</span>
    <span class="nv">reqPassword = </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">user_pass</span>
    <span class="nx">getTokenFromUserName</span> <span class="nx">reqName</span><span class="p">,</span> <span class="nx">reqPassword</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">account</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">render</span> <span class="nv">login: </span><span class="p">{</span><span class="nv">error: </span><span class="nx">err</span><span class="p">}</span>
      <span class="k">else</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">render</span> <span class="nv">login: </span><span class="p">{</span><span class="nv">userID: </span><span class="nx">matchingUser</span><span class="p">.</span><span class="nx">userID</span><span class="p">,</span> <span class="nv">token: </span><span class="nx">previousSession</span><span class="p">.</span><span class="nx">token</span><span class="p">}</span>
      
  <span class="nx">@view</span> <span class="nv">login: </span><span class="o">-&gt;</span>
    <span class="vi">@title = </span><span class="s">&#39;login&#39;</span>
    <span class="vi">@stylesheets = </span><span class="p">[</span><span class="s">&#39;/style&#39;</span><span class="p">]</span>
    <span class="vi">@scripts = </span><span class="p">[</span><span class="s">&#39;/zappa/jquery&#39;</span><span class="p">,</span><span class="s">&#39;/zappa/zappa&#39;</span><span class="p">,</span> <span class="s">&#39;/facebook&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">is</span> <span class="s">&#39;production&#39;</span>
      <span class="nx">coffeescript</span> <span class="o">-&gt;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nv">app_id = </span><span class="s">&#39;359933034051162&#39;</span>
    <span class="k">else</span>
      <span class="nx">coffeescript</span> <span class="o">-&gt;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nv">app_id = </span><span class="s">&#39;194436507332185&#39;</span>

    <span class="k">if</span> <span class="nx">@token</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">@userID</span> <span class="o">!=</span> <span class="kc">undefined</span>
      <span class="nx">p</span> <span class="s">&quot;{\&quot;userID\&quot; : \&quot;</span><span class="si">#{</span><span class="nx">@userID</span><span class="si">}</span><span class="s">\&quot;, \&quot;token\&quot; : \&quot;</span><span class="si">#{</span><span class="nx">@token</span><span class="si">}</span><span class="s">\&quot;}&quot;</span>
    <span class="k">else</span>
      <span class="nx">form</span> <span class="nv">method: </span><span class="s">&#39;post&#39;</span><span class="p">,</span> <span class="nv">action: </span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="nx">input</span> <span class="nv">id: </span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="nv">name: </span><span class="s">&#39;user_name&#39;</span><span class="p">,</span> <span class="nv">placeholder: </span><span class="s">&#39;login user&#39;</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">50</span>
        <span class="nx">input</span> <span class="nv">id: </span><span class="s">&#39;user_pass&#39;</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="nv">name: </span><span class="s">&#39;user_pass&#39;</span><span class="p">,</span> <span class="nv">placeholder: </span><span class="s">&#39;login pass&#39;</span><span class="p">,</span> <span class="nv">size: </span><span class="mi">50</span>
        <span class="nx">input</span> <span class="nv">id: </span><span class="s">&#39;fb_uid&#39;</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;hidden&#39;</span><span class="p">,</span> <span class="nv">name: </span><span class="s">&#39;fb_uid&#39;</span>
        <span class="nx">input</span> <span class="nv">id: </span><span class="s">&#39;fb_token&#39;</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;hidden&#39;</span><span class="p">,</span> <span class="nv">name: </span><span class="s">&#39;fb_token&#39;</span>
        <span class="nx">button</span> <span class="s">&#39;get token&#39;</span>

    <span class="nx">div</span> <span class="s">&#39;#fb-root&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nx">img</span> <span class="s">&#39;#fb_photo.hidden&#39;</span><span class="p">,</span> <span class="nv">src: </span><span class="s">&#39;&#39;</span>
      <span class="nx">a</span> <span class="s">&#39;#logout.hidden&#39;</span><span class="p">,</span> <span class="nv">href: </span><span class="s">&quot;</span><span class="err">#</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="s">&#39;Unlink Facebook account&#39;</span>
      <span class="nx">div</span> <span class="s">&#39;#fb-login.fb-login-button.hidden&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
        <span class="s">&#39;Link account with Facebook&#39;</span>

  <span class="nx">@get</span> <span class="s">&#39;/&#39;</span><span class="o">:</span> <span class="o">-&gt;</span>
    <span class="nv">sessionToken = </span><span class="kc">null</span>
    <span class="k">if</span> <span class="nx">@request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">sessiontoken</span><span class="o">?</span>
      <span class="nv">sessionToken = </span><span class="nx">@request</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">sessiontoken</span>
    <span class="nx">@render</span> <span class="nv">index: </span><span class="p">{</span><span class="nv">token: </span><span class="nx">sessionToken</span><span class="p">}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;resuming session of token </span><span class="si">#{</span><span class="nx">sessionToken</span><span class="si">}</span><span class="s">&quot;</span>

  <span class="nx">@</span><span class="kc">on</span> <span class="nv">connection: </span><span class="o">-&gt;</span>
    <span class="nx">@emit</span> <span class="nv">updateRequest: </span><span class="p">{</span><span class="nv">time: </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()}</span>
  
  <span class="nx">@</span><span class="kc">on</span> <span class="nv">statusUpdate: </span><span class="o">-&gt;</span>
    <span class="nx">tokenValidate</span> <span class="nx">@data</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">user</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="nx">@emit</span> <span class="nv">unauthorized: </span><span class="p">{}</span>
        <span class="k">return</span>
      <span class="nv">session.socketID = </span><span class="nx">@id</span>
      <span class="nv">location  = </span><span class="nx">@data</span><span class="p">.</span><span class="nx">location</span>
      <span class="nv">oldLocation = </span><span class="nx">session</span><span class="p">.</span><span class="nx">location</span>
      <span class="nv">session.location = </span><span class="nx">location</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>console.log session.valueOf()</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">user</span><span class="p">.</span><span class="nx">save</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1">#[{&quot;location&quot;:[44.680997,10.317557],&quot;socketID&quot;:&quot;1998803106463826141&quot;,&quot;token&quot;:&quot;TOKENBLAH_alex&quot;}]</span>
        <span class="k">if</span> <span class="nx">error</span><span class="o">?</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;error saving user after StatusUpdate </span><span class="si">#{</span> <span class="nx">error</span> <span class="si">}</span><span class="s">&quot;</span>
          <span class="nx">@emit</span> <span class="nv">serverError: </span><span class="o">-&gt;</span>
        <span class="k">else</span>
          <span class="nx">@emit</span> <span class="nv">updateGood: </span><span class="p">{}</span>
          <span class="nx">updateUniqueActiveSessionsNearLocationArray</span> <span class="p">[</span><span class="nx">location</span><span class="p">,</span> <span class="nx">oldLocation</span><span class="p">],</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">err</span>

  <span class="nx">@</span><span class="kc">on</span> <span class="nv">swypOut: </span><span class="o">-&gt;</span>
    <span class="nx">tokenValidate</span> <span class="nx">@data</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">session</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">user</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="nx">@emit</span> <span class="nv">unauthorized: </span><span class="p">{}</span>
        <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>implement function to evaluate user token and abort if invalid</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">supportedTypes = </span><span class="nx">@data</span><span class="p">.</span><span class="nx">typeGroups</span>
      <span class="nv">previewImage   = </span><span class="nx">@data</span><span class="p">.</span><span class="nx">previewImage</span>
      <span class="nv">recipientTo    = </span><span class="nx">@data</span><span class="p">.</span><span class="nx">to</span>
      <span class="nv">fromSender     = </span><span class="nx">user</span><span class="p">.</span><span class="nx">userID</span>
      <span class="nv">swypTime       = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="nv">swypExpire = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">valueOf</span><span class="p">()</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#expires in 50 seconds</span>
     
      <span class="nv">typeGroupsToSave = </span><span class="p">[]</span> <span class="c1">#this is for the datastore</span>
      <span class="nv">typeGroupsToSend = </span><span class="p">[]</span> <span class="c1">#this is for the swyp-out event</span>
      <span class="k">if</span> <span class="nx">@data</span><span class="p">.</span><span class="nx">typeGroups</span><span class="o">?</span> <span class="o">==</span> <span class="kc">false</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;swypOut had bad typeGroupStructure&quot;</span>
        <span class="nx">@emit</span> <span class="nv">badData: </span><span class="p">{}</span>
        <span class="k">return</span>
      <span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">@data</span><span class="p">.</span><span class="nx">typeGroups</span>
         <span class="nv">typeGroupObj = </span><span class="k">new</span> <span class="nx">TypeGroup</span> <span class="p">{</span><span class="nv">contentMIME: </span><span class="nx">type</span><span class="p">.</span><span class="nx">contentMIME</span><span class="p">}</span> <span class="c1">#no upload or completion date or timeouts</span>
         <span class="k">if</span> <span class="nx">type</span><span class="p">.</span><span class="nx">contentURL</span><span class="o">?</span>
           <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;url included </span><span class="si">#{</span><span class="nx">type</span><span class="p">.</span><span class="nx">contentURL</span><span class="si">}</span><span class="s">&quot;</span>
           <span class="nv">typeGroupObj.contentURL = </span><span class="nx">type</span><span class="p">.</span><span class="nx">contentURL</span>
           <span class="nv">typeGroupObj.uploadCompletionDate = </span><span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
         <span class="nx">typeGroupsToSave</span><span class="p">.</span><span class="nx">push</span> <span class="nx">typeGroupObj</span> <span class="c1">#this gets saved</span>
         <span class="nx">typeGroupsToSend</span><span class="p">.</span><span class="nx">push</span> <span class="nx">type</span><span class="p">.</span><span class="nx">contentMIME</span> <span class="c1">#this gets emitted </span>

      <span class="nv">nextSwyp = </span><span class="k">new</span> <span class="nx">Swyp</span> <span class="p">{</span><span class="nv">previewImage: </span><span class="nx">previewImage</span><span class="p">,</span> <span class="nv">swypOuter: </span><span class="nx">fromSender</span><span class="p">,</span> <span class="nv">dateCreated: </span><span class="nx">swypTime</span><span class="p">,</span> <span class="nv">dateExpires: </span><span class="nx">swypExpire</span><span class="p">,</span> <span class="nv">typeGroups: </span><span class="nx">typeGroupsToSave</span><span class="p">}</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">nextSwyp</span>
      <span class="nx">nextSwyp</span><span class="p">.</span><span class="nx">save</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">error</span> <span class="o">!=</span> <span class="kc">null</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;didFailSave&quot;</span><span class="p">,</span> <span class="nx">error</span>
          <span class="k">return</span>
        <span class="nv">swypOutPacket = </span><span class="p">{</span><span class="nv">id: </span><span class="nx">nextSwyp</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nv">swypOuter: </span><span class="nx">nextSwyp</span><span class="p">.</span><span class="nx">swypOuter</span><span class="p">,</span> <span class="nv">dateCreated: </span><span class="nx">nextSwyp</span><span class="p">.</span><span class="nx">dateCreated</span><span class="p">,</span> <span class="nv">dateExpires: </span><span class="nx">nextSwyp</span><span class="p">.</span><span class="nx">dateExpires</span><span class="p">,</span> <span class="nv">availableMIMETypes: </span><span class="nx">typeGroupsToSend</span><span class="p">}</span>
        <span class="nx">@emit</span> <span class="nv">swypOutPending: </span><span class="nx">swypOutPacket</span> <span class="c1">#this sends only the MIMES</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;new swypOut saved&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>if no target recpient, you're swyping to area/'room'</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">recipientTo</span><span class="o">?</span> <span class="o">==</span> <span class="kc">false</span>
          <span class="nx">accountsAndSessionsNearLocation</span> <span class="nx">session</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="p">(</span><span class="nx">sessionsByAccount</span><span class="p">,</span> <span class="nx">allSessions</span><span class="p">)</span> <span class="o">=&gt;</span>
             <span class="k">if</span> <span class="nx">allSessions</span><span class="o">?</span>
              <span class="k">for</span> <span class="nx">updateSession</span> <span class="k">in</span> <span class="nx">allSessions</span>
                <span class="nv">socket = </span><span class="nx">socketForSession</span><span class="p">(</span><span class="nx">updateSession</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">socket</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">updateSession</span><span class="p">.</span><span class="nx">socketID</span> <span class="o">!=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">socketID</span>
                   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;updating swypout for sessionID </span><span class="si">#{</span><span class="nx">updateSession</span><span class="p">.</span><span class="nx">socketID</span><span class="si">}</span><span class="s">&quot;</span>
                   <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s">&#39;swypInAvailable&#39;</span><span class="p">,</span> <span class="nx">swypOutPacket</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;swypOut targetted to </span><span class="si">#{</span><span class="nx">recipientTo</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>otherwise, there is a target recipient</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">accountForUserID</span> <span class="nx">recipientTo</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="nx">account</span><span class="p">,</span> <span class="nx">activeSessions</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="k">if</span> <span class="nx">activeSessions</span><span class="o">?</span>
              <span class="k">for</span> <span class="nx">updateSession</span> <span class="k">in</span> <span class="nx">activeSessions</span>
                <span class="nv">socket = </span><span class="nx">socketForSession</span><span class="p">(</span><span class="nx">updateSession</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">socket</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">updateSession</span><span class="p">.</span><span class="nx">socketID</span> <span class="o">!=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">socketID</span>
                   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;updating swypout for sessionID </span><span class="si">#{</span><span class="nx">updateSession</span><span class="p">.</span><span class="nx">socketID</span><span class="si">}</span><span class="s">&quot;</span>
                   <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s">&#39;swypInAvailable&#39;</span><span class="p">,</span> <span class="nx">swypOutPacket</span><span class="p">)</span>

  <span class="nv">swypForID = </span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1">#{callback(err, swypObj)}</span>
    <span class="nv">objID = </span><span class="nx">mongoose</span><span class="p">.</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">BSONPure</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">.</span><span class="nx">fromString</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="nx">Swyp</span><span class="p">.</span><span class="nx">findOne</span> <span class="p">{</span><span class="nv">_id: </span><span class="nx">objID</span><span class="p">},</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span> <span class="o">or</span> <span class="p">(</span><span class="nx">obj</span><span class="o">?</span> <span class="o">==</span> <span class="kc">false</span><span class="p">)</span>
         <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="kc">null</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;no swyp for id </span><span class="si">#{</span><span class="nx">id</span><span class="si">}</span><span class="s"> found, w. err </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
         <span class="k">return</span>
      <span class="k">if</span> <span class="nx">obj</span><span class="o">?</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span>
  
  <span class="nv">typeGroupFromMIMEInSwyp = </span><span class="p">(</span><span class="nx">contentMIMEType</span><span class="p">,</span> <span class="nx">swyp</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">for</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">swyp</span><span class="p">.</span><span class="nx">typeGroups</span>
      <span class="k">if</span> <span class="nx">contentMIMEType</span> <span class="o">==</span> <span class="nx">type</span><span class="p">.</span><span class="nx">contentMIME</span>
        <span class="k">return</span> <span class="nx">type</span>
    <span class="k">return</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">The</span> <span class="nx">@</span><span class="kc">on</span> <span class="nx">swypIn</span> <span class="nx">event</span> <span class="nx">triggers</span> <span class="nx">from</span> <span class="nx">client</span><span class="s">&#39;s swypIn-action.</span>
<span class="s">  The client passes its requested contentMIME, and this server either immediately emits the contentURL at which the content of contentMIME is available, or it requests the upload of said MIME to a specific URL given by this server.</span>

<span class="s">#DIVIDER</span>
<span class="s">  @on swypIn: -&gt;</span>
<span class="s">    tokenValidate @data.token, (user, session) =&gt;</span>
<span class="s">      if user == null</span>
<span class="s">        @emit unauthorized: {}</span>
<span class="s">        return</span>
<span class="s">      contentID   = @data.id</span>
<span class="s">      contentType = @data.contentMIME</span>
<span class="s">      swypForID contentID, (err, swyp) =&gt;</span>
<span class="s">        if swyp?</span>
<span class="s">          typeGroupObj = typeGroupFromMIMEInSwyp contentType, swyp</span>
<span class="s">          if typeGroupObj? &amp;&amp; typeGroupObj.uploadCompletionDate?</span>
<span class="s">            @emit dataAvailable:</span>
<span class="s">              {id: contentID, \</span>
<span class="s">              contentMIME: contentType,\</span>
<span class="s">              contentURL: typeGroupObj.contentURL}</span>
<span class="s">          else</span>
<span class="s">            uploadURL   = &quot;http://newUploadURL&quot;</span>
<span class="s">            @emit dataPending:</span>
<span class="s">              {id: contentID, \</span>
<span class="s">               type: contentType}</span>
<span class="s">            @broadcast dataRequest:</span>
<span class="s">              {id: contentID, \</span>
<span class="s">               type: contentType,</span>
<span class="s">               uploadURL: uploadURL}</span>
<span class="s">     </span>
<span class="s">  @on uploadCompleted: -&gt;</span>
<span class="s">    tokenValidate @data.token, (user, session) =&gt;</span>
<span class="s">      if user == null</span>
<span class="s">        @emit unauthorized: {}</span>
<span class="s">        return</span>
<span class="s">      contentID   = @data.id</span>
<span class="s">      contentType = @data.type</span>
<span class="s">      uploadURL   = &quot;http://dbRetrievedUploadURL&quot;</span>
<span class="s">      console.log @io.sockets</span>
<span class="s">      @broadcast dataAvailable:</span>
<span class="s">         {id: contentID, \</span>
<span class="s">         type: contentType,\</span>
<span class="s">         uploadURL: uploadURL}</span>

<span class="s">#DIVIDER</span>

<span class="s">  @coffee &#39;</span><span class="o">/</span><span class="nx">facebook</span><span class="p">.</span><span class="nx">js</span><span class="s">&#39;: -&gt;</span>
<span class="s">    handleFBStatus = (res)-&gt;</span>
<span class="s">      switch res.status</span>
<span class="s">        when &#39;</span><span class="nx">connected</span><span class="s">&#39;</span>
<span class="s">          uid = res.authResponse.userID</span>
<span class="s">          access_token = res.authResponse.accessToken</span>
<span class="s">          console.log &quot;authorized with uid: #{uid} and access token: #{access_token}&quot;</span>
<span class="s">          $(&quot;#fb_photo&quot;).removeClass(&quot;hidden&quot;).attr(&quot;src&quot;, &quot;http://graph.facebook.com/#{uid}/picture&quot;)</span>
<span class="s">          $(&#39;</span><span class="c1">#fb_uid&#39;).val uid</span>
          <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#fb_token&#39;</span><span class="p">).</span><span class="nx">val</span> <span class="nx">access_token</span>
          <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#logout&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>
          <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#fb-login&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>
        <span class="k">when</span> <span class="s">&#39;not_authorized&#39;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;user is logged in, but has not authorized app&#39;</span>
        <span class="k">else</span> <span class="c1"># user is not logged in</span>
          <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#logout&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>
          <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#fb-login&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>

    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#logout&#39;</span><span class="p">).</span><span class="nx">live</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="nf">(e)-&gt;</span>
      <span class="nx">FB</span><span class="p">.</span><span class="nx">logout</span> <span class="nf">(res)-&gt;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">res</span>

    <span class="nb">window</span><span class="p">.</span><span class="nv">fbAsyncInit = </span><span class="o">-&gt;</span>
      <span class="nx">FB</span><span class="p">.</span><span class="nx">init</span> <span class="p">{</span>
        <span class="nv">appId: </span><span class="nx">app_id</span><span class="p">,</span>
        <span class="nv">status: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">cookie: </span><span class="kc">true</span><span class="p">,</span> <span class="nv">xfbml: </span><span class="kc">true</span>
      <span class="p">}</span>

      <span class="nx">FB</span><span class="p">.</span><span class="nx">getLoginStatus</span> <span class="nx">handleFBStatus</span>
      <span class="nx">FB</span><span class="p">.</span><span class="nx">Event</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s">&#39;auth.authResponseChange&#39;</span><span class="p">,</span> <span class="nx">handleFBStatus</span>

    
    <span class="p">(</span><span class="nf">(d)-&gt;</span>
      <span class="nv">js  = id = </span><span class="s">&#39;facebook-jssdk&#39;</span>
      <span class="nv">ref = </span><span class="nx">d</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getElementById</span> <span class="nx">id</span> <span class="k">then</span> <span class="k">return</span>
      <span class="nv">js = </span><span class="nx">d</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;script&#39;</span>
      <span class="nv">js.id    = </span><span class="nx">id</span>
      <span class="nv">js.async = </span><span class="kc">true</span>
      <span class="nv">js.src   = </span><span class="s">&quot;//connect.facebook.net/en_US/all.js&quot;</span>
      <span class="nx">ref</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span> <span class="nx">js</span><span class="p">,</span> <span class="nx">ref</span>
    <span class="p">)(</span><span class="nb">document</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">port = </span><span class="k">if</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="k">else</span> <span class="mi">3000</span>
<span class="nx">swypApp</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;starting on port </span><span class="err">#</span><span class="s"> </span><span class="si">#{</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>io.sockets.sockets[sid].json.send -> #send to particularly waiting clients</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>client code moved to swypClient.coffee</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 