<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="d3.v2.min.js"></script>
<script type="text/javascript" src="force.js"></script>
<style type="text/css">
.link { stroke: #ccc; }
.hovered { stroke: #000; }
.nodetext { pointer-events: none; font: 14px sans-serif; }
.hovered.nodetext { stroke: #ccc; }
</style>
</head>
<body>
<script type="text/javascript">

var body = d3.select("body");
var w, h; 

function resize() {
  w = body.attr("width");
  h = body.attr("height");
  force.size([w,h]);
  vis.attr("width", w)
     .attr("height", h);
}

var collides = function(el, event){
  var rect = el.getBoundingClientRect();

  if ((event.x >= rect.left && event.x <= rect.right) &&
      (event.y >= rect.top && event.y <= rect.bottom)){
    return true;
  }
  return false;
}

var x, y;

var node, link;
var force = self.force = d3.layout.force();

var vis = body.append("svg:svg");

// add support for d3.touches too
body.on("mousedown", function(){
  x = d3.event.x;
  y = d3.event.y;
  force.start();
  
  body.on("mousemove", function(){
    link.each(function(d, i){
      d3.select(this).attr("class", collides(this, d3.event) ? 
                                    "hovered": "link");
    });

    node.each(function(d, i){
      d3.select(this).attr("class", collides(this, d3.event) ? 
                                    "hovered": "node");
    });
  });
}).on("mouseup", function(){
  link.attr("class", "link");
  node.attr("class", "node");
  body.on("mousemove", null);
});

d3.json("graph.json", function(json) {
    force.nodes(json.nodes)
        .links(json.links)
        .gravity(0)
        .distance(100)
        .charge(-500)
        .start();

    link = vis.selectAll("line.link")
        .data(json.links)
        .enter().append("svg:line")
        .attr("class", "link")
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node = vis.selectAll("g.node")
        .data(json.nodes)
      .enter().append("svg:g")
        .attr("class", "node");

    node.append("svg:image")
        .attr("class", "circle")
        .attr("xlink:href", "https://d3nwyuy0nl342s.cloudfront.net/images/icons/public.png")
        .attr("x", "-8px")
        .attr("y", "-8px")
        .attr("width", "16px")
        .attr("height", "16px");

    node.append("svg:text")
        .attr("class", "nodetext")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(function(d) { return d.name });

    force.on("tick", function(e) {
        resize();

        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("transform", function(d) { 
            if (d.index === 0){
              if (x) {
                var damper = 0.1;
                d.x = d.x + (x - d.x) * (damper + 0.71) * e.alpha;
                d.y = d.y + (y - d.y) * (damper + 0.71) * e.alpha;
              } else {
                d.x = 400;
                d.y = 400;
              }
            }
            return "translate(" + d.x + "," + d.y + ")"; 
        });
    });
});

</script>
</body>
</html>